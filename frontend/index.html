<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>SAARTHI Starter UI</title>

    <!-- Tailwind (for quick styling) -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- React 18 (UMD) + Babel so JSX works without a build step -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
      .card { background:#fff; border-radius:16px; box-shadow: 0 6px 24px rgba(0,0,0,0.06); padding:24px; border:1px solid #eef2f7; }
      .btn { display:inline-flex; align-items:center; justify-content:center; gap:8px; padding:8px 14px; font-weight:600; border:1px solid #e5e7eb; border-radius:12px; transition:all .15s; }
      .btn:hover { transform: translateY(-1px); }
      .btn-primary { background:#2563eb; color:#fff; border-color:#1d4ed8; }
      .btn-outline { background:#fff; color:#374151; }
      .badge { display:inline-flex; align-items:center; gap:6px; padding:4px 10px; border:1px solid #e5e7eb; border-radius:999px; font-size:12px; background:#f3f4f6; color:#374151; }
      .input { border:1px solid #e5e7eb; border-radius:12px; padding:10px 12px; outline:none; width:100%; }
      .input:focus { border-color:#2563eb; box-shadow:0 0 0 3px rgba(37,99,235,0.15); }
      .kbd { font-family: ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace; font-size:12px; background:#f3f4f6; border:1px solid #e5e7eb; padding:2px 6px; border-radius:6px; }
      .mono { font-family: ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace; }
    </style>
  </head>
  <body class="bg-slate-50">
    <div id="root"></div>

    <script type="text/babel" data-presets="react">
      const { useEffect, useMemo, useState } = React;

      // Allow ?api=https://your-api.onrender.com, else fallback to localhost for local dev
      const API_BASE = (new URLSearchParams(location.search).get('api')) || 'http://localhost:8000';

      async function api(path, opts = {}) {
        const res = await fetch(API_BASE + path, { headers: { "Content-Type": "application/json" }, ...opts });
        if (!res.ok) {
          const txt = await res.text().catch(()=> "");
          throw new Error(`HTTP ${res.status} ${res.statusText} — ${txt || path}`);
        }
        // Some endpoints may return plain text; try JSON first then fallback
        const ct = res.headers.get("content-type") || "";
        if (ct.includes("application/json")) return res.json();
        return res.text();
      }

      function CodeBlock({ data }) {
        const text = typeof data === "string" ? data : JSON.stringify(data, null, 2);
        return (
          <pre className="mono text-xs bg-slate-50 border border-slate-200 rounded-xl p-3 overflow-auto max-h-96">
{String(text)}
          </pre>
        );
      }

      function SectionTitle({ children }) {
        return <h2 className="text-lg font-semibold mb-2">{children}</h2>;
      }

      function App() {
        const [error, setError] = useState("");
        const [pingOk, setPingOk] = useState(false);

        // Search
        const [q, setQ] = useState("");
        const [codes, setCodes] = useState([]);

        // ValueSet & ConceptMap
        const [vs, setVs] = useState(null);
        const [cmap, setCmap] = useState(null);

        // Bundle summary demo
        const [bundleText, setBundleText] = useState(`{
  "resourceType": "Bundle",
  "type": "collection",
  "entry": [
    { "resource": { "resourceType": "Patient", "id": "pat-1" } },
    { "resource": { "resourceType": "Encounter", "id": "enc-1" } },
    { "resource": { "resourceType": "Condition",
      "code": { "coding": [ { "system":"urn:icd:icd11:tm", "code":"TM2-0004", "display":"Amlapitta" } ] } } },
    { "resource": { "resourceType": "Procedure",
      "code": { "coding": [ { "system":"urn:icd:icd11:tm", "code":"TM2-PROC-003", "display":"Vamana Karma" } ] } } },
    { "resource": { "resourceType": "Observation",
      "code": { "text": "Dosha Assessment" }, "valueString": "Pitta dominant" } }
  ]
}`);
        const [bundleSummary, setBundleSummary] = useState(null);

        useEffect(() => {
          // quick connectivity check using /docs (always exists) or a known GET
          fetch(API_BASE + "/docs", { method: "GET" })
            .then(r => setPingOk(r.ok))
            .catch(() => setPingOk(false));
        }, []);

        async function doSearch() {
          setError("");
          setCodes([]);
          try {
            const data = await api(`/codes/search?q=${encodeURIComponent(q)}`);
            setCodes(data || []);
          } catch (e) { setError(String(e)); }
        }

        async function loadVS() {
          setError("");
          setVs(null);
          try { setVs(await api("/valueset")); }
          catch (e) { setError(String(e)); }
        }

        async function loadCMap() {
          setError("");
          setCmap(null);
          try { setCmap(await api("/conceptmap")); }
          catch (e) { setError(String(e)); }
        }

        async function summarizeBundle() {
          setError("");
          setBundleSummary(null);
          try {
            const obj = JSON.parse(bundleText);
            const data = await api("/bundle/summary", {
              method: "POST",
              body: JSON.stringify(obj)
            });
            setBundleSummary(data);
          } catch (e) { setError(String(e)); }
        }

        return (
          <div className="max-w-5xl mx-auto p-6 space-y-5">
            <header className="flex items-center justify-between">
              <div>
                <h1 className="text-2xl font-bold">SAARTHI Starter UI</h1>
                <p className="text-slate-600 mt-1">API: <span className="badge">{API_BASE}</span></p>
              </div>
              <div className={`badge ${pingOk ? "border-green-200 bg-green-50 text-green-700" : "border-amber-200 bg-amber-50 text-amber-700"}`}>
                {pingOk ? "API reachable" : "Waiting for API…"}
              </div>
            </header>

            <div className="card space-y-3">
              <SectionTitle>Search Codes</SectionTitle>
              <div className="flex gap-2">
                <input
                  className="input"
                  placeholder="Try: Amlapitta, Sandhivata, Vamana, Nasya"
                  value={q}
                  onChange={e=>setQ(e.target.value)}
                  onKeyDown={e=>{ if (e.key === "Enter") doSearch(); }}
                />
                <button className="btn btn-primary" onClick={doSearch}>Search</button>
              </div>
              {codes?.length ? (
                <>
                  <div className="text-sm text-slate-600">Results: <span className="mono">{codes.length}</span></div>
                  <CodeBlock data={codes}/>
                </>
              ) : <div className="text-sm text-slate-500">No results yet. Enter a query and press <span className="kbd">Enter</span> or click <span className="kbd">Search</span>.</div>}
            </div>

            <div className="grid md:grid-cols-2 gap-5">
              <div className="card space-y-3">
                <SectionTitle>ValueSet (demo)</SectionTitle>
                <div className="flex gap-2">
                  <button className="btn btn-outline" onClick={loadVS}>Load ValueSet</button>
                </div>
                {vs && <CodeBlock data={vs}/>}
              </div>

              <div className="card space-y-3">
                <SectionTitle>ConceptMap (demo)</SectionTitle>
                <div className="flex gap-2">
                  <button className="btn btn-outline" onClick={loadCMap}>Load ConceptMap</button>
                </div>
                {cmap && <CodeBlock data={cmap}/>}
              </div>
            </div>

            <div className="card space-y-3">
              <SectionTitle>FHIR Bundle → Summary</SectionTitle>
              <div className="grid md:grid-cols-2 gap-4">
                <textarea
                  className="input mono min-h-[220px]"
                  value={bundleText}
                  onChange={e=>setBundleText(e.target.value)}
                />
                <div className="space-y-2">
                  <button className="btn btn-primary" onClick={summarizeBundle}>Summarize Bundle</button>
                  {bundleSummary
                    ? <CodeBlock data={bundleSummary}/>
                    : <div className="text-sm text-slate-500">Paste/edit a small FHIR Bundle and click <span className="kbd">Summarize Bundle</span>.</div>}
                </div>
              </div>
            </div>

            {error && <div className="bg-red-50 text-red-700 border border-red-200 rounded-xl p-3">{error}</div>}

            <footer className="text-xs text-slate-500">© SAARTHI Starter Kit — Demo subset for evaluation only</footer>
          </div>
        );
      }

      ReactDOM.createRoot(document.getElementById("root")).render(<App/>);
    </script>
  </body>
</html>
