<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>SAARTHI — Terminology & FHIR Demo</title>

    <!-- Tailwind CDN -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- React 18 UMD + Babel for JSX (no build step needed) -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
      :root{
        --fg:#0f172a; --muted:#4b5563; --line:#e5e7eb; --card:#ffffff;
        --brand:#2563eb; --brand-700:#1d4ed8; --brand-50:#eff6ff;
      }
      body{
        color:var(--fg);
        background:
          radial-gradient(1200px 600px at 80% -10%, #e0f2fe 0%, transparent 40%),
          radial-gradient(900px 500px at 10% 0%, #eef2ff 0%, transparent 45%),
          #f8fafc;
      }
      .container{ max-width:1200px; }
      .card{
        background:var(--card); border:1px solid var(--line); border-radius:16px; padding:20px;
        box-shadow:0 15px 35px rgba(2,6,23,.06), 0 5px 15px rgba(2,6,23,.04);
      }
      .btn{
        display:inline-flex; align-items:center; justify-content:center; gap:8px;
        padding:10px 14px; font-weight:600; border-radius:12px; border:1px solid var(--line);
        background:#fff; transition:all .15s;
      }
      .btn:hover{ transform:translateY(-1px); }
      .btn-primary{ background:var(--brand); color:#fff; border-color:var(--brand-700); }
      .btn-soft{ background:var(--brand-50); color:var(--brand); border-color:#bfdbfe; }
      .badge{
        display:inline-flex; align-items:center; gap:6px; padding:4px 10px; border:1px solid var(--line);
        border-radius:999px; font-size:12px; background:#f1f5f9; color:#334155;
      }
      .badge-ok{ border-color:#bbf7d0; background:#f0fdf4; color:#166534; }
      .badge-warn{ border-color:#fde68a; background:#fffbeb; color:#92400e; }
      .input{ border:1px solid var(--line); border-radius:12px; padding:10px 12px; outline:none; width:100%; background:#fff; }
      .input:focus{ border-color:var(--brand); box-shadow:0 0 0 3px rgba(37,99,235,.15); }
      .mono{ font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace; }
      .toast{ position:fixed; right:16px; bottom:16px; background:#0b1220; color:#fff; padding:12px 14px; border-radius:12px; box-shadow:0 8px 24px rgba(0,0,0,.2); }
      .row{ display:flex; align-items:center; justify-content:space-between; gap:10px; padding:10px; border:1px solid var(--line); border-radius:12px; background:#fff; }
      .table{ width:100%; border-collapse:separate; border-spacing:0; }
      .table th,.table td{ text-align:left; font-size:12px; padding:8px 10px; border-bottom:1px solid #eef2f7; }
      .table th{ font-weight:700; color:#334155; }
      .hint{ font-size:12px; color:#4b5563; }
      .title{ font-size:1.05rem; font-weight:700; letter-spacing:.2px; }
    </style>
  </head>
  <body>
    <div id="root"></div>

    <script type="text/babel" data-presets="react">
      const { useEffect, useRef, useState } = React;

      /* ---------- Utilities ---------- */
      function getInitialApi(){
        const qs = new URLSearchParams(location.search).get('api');
        if(qs) return qs;
        const saved = localStorage.getItem('API_BASE');
        return saved || 'http://localhost:8000';
      }
      async function http(base, path, opts={}){
        const hasBody = typeof opts.body !== 'undefined';
        const headers = hasBody ? { 'Content-Type':'application/json' } : {};
        const res = await fetch(base+path, { ...opts, headers:{ ...headers, ...(opts.headers||{}) }});
        if(!res.ok){
          let t=''; try{ t = await res.text(); }catch{}
          throw new Error(`HTTP ${res.status} ${res.statusText}${t ? ' — '+t : ''}`);
        }
        const ct = res.headers.get('content-type') || '';
        return ct.includes('application/json') ? res.json() : res.text();
      }
      function useDebounced(value, delay=350){
        const [v,setV] = useState(value);
        useEffect(()=>{ const t=setTimeout(()=>setV(value), delay); return ()=>clearTimeout(t); }, [value,delay]);
        return v;
      }
      function downloadText(name, text, type='application/json'){
        const blob = new Blob([text], {type});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href=url; a.download=name; a.click();
        URL.revokeObjectURL(url);
      }
      function toCSV(rows, header){
        const esc = s => `"${String(s??'').replace(/"/g,'""')}"`;
        return [header.map(esc).join(','), ...rows.map(r=>header.map(h=>esc(r[h])).join(','))].join('\n');
      }
      function toNDJSON(arr){ return arr.map(x=>JSON.stringify(x)).join('\n'); }
      function categorize(display=''){
        const d = display.toLowerCase();
        if (/(angina|myocard|heart|cad|hypertension|cholesterol|atrial|afib|stroke|dvt|pe|thrombo)/.test(d)) return 'Cardiology';
        if (/(diabetes|thyroid|obesity|pcos|endocr|hypo|hyperthy)/.test(d)) return 'Endocrine';
        if (/(asthma|copd|cough|pneumonia|tb|respir|swasa|kasa|bronch)/.test(d)) return 'Respiratory';
        if (/(gerd|ulcer|liver|hepat|pancrea|appendic|gall|ibs|ibd|gastr|chole)/.test(d)) return 'Gastrointestinal';
        if (/(ckd|kidney|uti|renal|nephro|prostat)/.test(d)) return 'Renal/Uro';
        if (/(migraine|epilep|neuro|palsy|sciatica)/.test(d)) return 'Neurology';
        if (/(depress|anxiety|bipolar|schizo|autism|adhd|insomnia)/.test(d)) return 'Psych';
        if (/(arthritis|spond|back pain|osteop|gout|bursitis|tendin|frozen shoulder)/.test(d)) return 'Ortho/MSK';
        if (/(eczema|psoriasis|dermat|urticaria|tinea|acne|cellulitis|scabies)/.test(d)) return 'Derm';
        if (/(dengue|malaria|typhoid|covid|influenza|measles|mumps|rubella|lepto|tuberc)/.test(d)) return 'Infectious';
        if (/(pregnan|preeclampsia|endometri|pid|pcos|fibroids|gdm|dysmen)/.test(d)) return 'Gyn/OB';
        if (/(procedure|karma|therapy|basti|vamana|virechana|nasya|abhyanga|shirodhara|raktamok)/.test(d)) return 'Procedure/Therapy';
        return 'Other';
      }
      function CodeBlock({data}){
        const text = typeof data === 'string' ? data : JSON.stringify(data, null, 2);
        return <pre className="mono text-xs bg-slate-50 border border-slate-200 rounded-xl p-3 overflow-auto max-h-96 whitespace-pre-wrap">{String(text)}</pre>;
      }

      /* ---------- App ---------- */
      function App(){
        const [apiBase, setApiBase] = useState(getInitialApi());
        const [pingOk, setPingOk] = useState(false);
        useEffect(()=>{
          localStorage.setItem('API_BASE', apiBase);
          fetch(apiBase + '/openapi.json').then(r=>setPingOk(r.ok)).catch(()=>setPingOk(false));
        }, [apiBase]);

        const [vs, setVs] = useState(null);
        const [cmap, setCmap] = useState(null);
        useEffect(()=>{
          http(apiBase, '/valueset').then(setVs).catch(()=>{});
          http(apiBase, '/conceptmap').then(setCmap).catch(()=>{});
        }, [apiBase]);

        /* Search + suggestions */
        const [q,setQ] = useState('');
        const dq = useDebounced(q, 350);
        const [category, setCategory] = useState('All');
        const [codes, setCodes] = useState([]);
        const [showResults, setShowResults] = useState(true);

        useEffect(()=>{
          if(!dq){ setCodes([]); return; }
          http(apiBase, `/codes/search?q=${encodeURIComponent(dq)}`)
            .then(data=>{
              const enriched = (data||[]).map(c=>({...c, category:categorize(c.display||c.code)}));
              setCodes(category==='All' ? enriched : enriched.filter(c=>c.category===category));
              setShowResults(true);
            })
            .catch(()=>setCodes([]));
        }, [dq, apiBase, category]);

        const categories = ['All','Cardiology','Endocrine','Respiratory','Gastrointestinal','Renal/Uro','Neurology','Psych','Ortho/MSK','Derm','Infectious','Gyn/OB','Procedure/Therapy','Other'];

        /* Validation list */
        const [valList, setValList] = useState([]);
        function enqueueValidation(c){
          setShowResults(false);
          setValList(prev=>{
            if(prev.find(x=>x.code===c.code)) return prev;
            return [...prev, { code:c.code, display:c.display, system:c.system }];
          });
          http(apiBase, `/codes/validate?code=${encodeURIComponent(c.code)}`)
            .then(res=>setValList(prev=>prev.map(x=>x.code===c.code?{...x, result:res}:x)))
            .catch(()=>setValList(prev=>prev.map(x=>x.code===c.code?{...x, result:{error:true}}:x)));
        }
        function validateAll(){
          setShowResults(false);
          const work = [...valList];
          Promise.all(work.map(item =>
            http(apiBase, `/codes/validate?code=${encodeURIComponent(item.code)}`)
              .then(r=>({code:item.code, r}))
              .catch(()=>({code:item.code, r:{error:true}}))
          )).then(results=>{
            setValList(prev=>prev.map(x=>{
              const hit = results.find(y=>y.code===x.code);
              return hit ? {...x, result:hit.r} : x;
            }));
          });
        }
        function removeVal(code){ setValList(prev=>prev.filter(x=>x.code!==code)); }
        function clearVal(){ setValList([]); }

        /* Bundle editor */
        const [bundleText, setBundleText] = useState(`{
  "resourceType": "Bundle",
  "type": "collection",
  "entry": [
    { "resource": { "resourceType": "Patient", "id": "pat-1" } },
    { "resource": { "resourceType": "Encounter", "id": "enc-1" } }
  ]
}`);
        const [bundleSummary, setBundleSummary] = useState(null);

        function insertIntoBundle(c){
          setShowResults(false);
          try{
            const obj = JSON.parse(bundleText);
            const entry = obj.entry || (obj.entry = []);
            entry.push({
              resource:{
                resourceType:"Condition",
                code:{ coding:[{ system:c.system || "urn:icd:icd11:tm", code:c.code, display:c.display }] }
              }
            });
            setBundleText(JSON.stringify(obj, null, 2));
            enqueueValidation(c);
          }catch{ alert('Bundle JSON invalid; cannot insert'); }
        }
        async function summarizeBundle(){
          try{
            const obj = JSON.parse(bundleText);
            const data = await http(apiBase, '/bundle/summary', { method:'POST', body:JSON.stringify(obj) });
            setBundleSummary(data);
          }catch(e){ alert(e.message || 'Invalid JSON'); }
        }
        function importFileChanged(e){
          const f = e.target.files?.[0]; if(!f) return;
          const reader = new FileReader();
          reader.onload = ()=>{
            try{
              const txt = String(reader.result||''); JSON.parse(txt);
              setBundleText(txt);
            }catch{ alert('Invalid JSON file'); }
          };
          reader.readAsText(f); e.target.value='';
        }
        function downloadBundle(filename='fhir-bundle.json'){
          try{ const txt=bundleText.trim(); JSON.parse(txt); downloadText(filename, txt); }
          catch{ alert('Bundle is not valid JSON'); }
        }
        async function exportFHIR(){
          try{
            const obj = JSON.parse(bundleText);
            let res;
            try{ res = await http(apiBase, '/export/fhir/bundle', { method:'POST', body:JSON.stringify(obj) }); }
            catch{ res = await http(apiBase, '/export/bundle', { method:'POST', body:JSON.stringify(obj) }); }
            const data = typeof res === 'string' ? res : JSON.stringify(res, null, 2);
            downloadText('fhir-bundle-export.json', data, 'application/fhir+json');
          }catch{ downloadBundle('fhir-bundle-export.json'); }
        }

        /* Exports */
        const [buildingCodes, setBuildingCodes] = useState(false);
        function exportValueSet(fmt='json'){
          if(!vs) return alert('Load ValueSet first (or wait)');
          if(fmt==='json') return downloadText('valueset.json', JSON.stringify(vs, null, 2));
          if(fmt==='ndjson') return downloadText('valueset.ndjson', toNDJSON([vs]), 'application/x-ndjson');
          if(fmt==='csv'){ const rows=(vs.includes||[]).map(code=>({code})); return downloadText('valueset.csv', toCSV(rows, ['code']), 'text/csv'); }
        }
        function exportConceptMap(fmt='json'){
          if(!cmap) return alert('Load ConceptMap first (or wait)');
          if(fmt==='json') return downloadText('conceptmap.json', JSON.stringify(cmap, null, 2));
          if(fmt==='ndjson') return downloadText('conceptmap.ndjson', toNDJSON(cmap.mappings||[]), 'application/x-ndjson');
          if(fmt==='csv'){ const rows=(cmap.mappings||[]).map(m=>({sourceCode:m.sourceCode, targetCode:m.targetCode, relation:m.relation})); return downloadText('conceptmap.csv', toCSV(rows, ['sourceCode','targetCode','relation']), 'text/csv'); }
        }
        async function exportCodesCSV(){
          if(!vs) return alert('ValueSet not loaded yet');
          setBuildingCodes(true);
          try{
            const all = vs.includes || [];
            const out = [];
            const limit = 8;
            let i=0;
            async function worker(){
              while(i<all.length){
                const idx=i++; const code=all[idx];
                try{
                  const r = await http(apiBase, `/codes/validate?code=${encodeURIComponent(code)}`);
                  out.push({ code, display:r.display||'', system:r.system||'', exists:r.exists?'yes':'no', inValueSet:r.inValueSet?'yes':'no' });
                }catch{ out.push({ code, display:'', system:'', exists:'', inValueSet:'' }); }
              }
            }
            await Promise.all(new Array(limit).fill(0).map(worker));
            downloadText('codes.csv', toCSV(out, ['code','display','system','exists','inValueSet']), 'text/csv');
          } finally { setBuildingCodes(false); }
        }

        return (
          <div className="container mx-auto p-6 space-y-6">
            <header className="card">
              <div className="flex items-center justify-between gap-3 flex-wrap">
                <div>
                  <h1 className="text-2xl md:text-3xl font-bold tracking-tight">SAARTHI — Terminology &amp; FHIR Demo</h1>
                  <p className="text-sm text-slate-600 mt-1">API: <span className="badge">{apiBase}</span></p>
                </div>
                <div className="flex items-center gap-2">
                  <input className="input w-[300px]" value={apiBase} onChange={e=>setApiBase(e.target.value)} placeholder="https://your-api.onrender.com"/>
                  <span className={`badge ${pingOk ? 'badge-ok' : 'badge-warn'}`}>{pingOk ? 'API online' : 'Waiting for API…'}</span>
                </div>
              </div>
            </header>

            {/* Search + Filter */}
            <section className="grid md:grid-cols-2 gap-5">
              <div className="card space-y-3">
                <div className="flex items-center justify-between">
                  <h2 className="title">Search Codes</h2>
                  <span className="hint">Type to search, filter by category, then Insert or Validate</span>
                </div>
                <div className="grid grid-cols-1 md:grid-cols-3 gap-2">
                  <input className="input md:col-span-2" placeholder="Try: Amlapitta, Vamana, Hypertension, Asthma…" value={q} onChange={e=>setQ(e.target.value)} />
                  <select className="input" value={category} onChange={e=>setCategory(e.target.value)}>
                    {categories.map(c=><option key={c} value={c}>{c}</option>)}
                  </select>
                </div>

                {showResults && codes?.length ? (
                  <div className="space-y-2">
                    {codes.slice(0,50).map((c,i)=>(
                      <div className="row" key={i}>
                        <div>
                          <div className="font-semibold">{c.display} <span className="mono text-xs text-slate-500">{c.code}</span></div>
                          <div className="text-[11px] text-slate-500">{(c.synonyms||[]).join(', ')}</div>
                          <div className="text-[11px] text-slate-500">Category: {c.category}</div>
                        </div>
                        <div className="flex gap-2">
                          <button className="btn btn-soft" onClick={()=>insertIntoBundle(c)}>Insert</button>
                          <button className="btn" onClick={()=>enqueueValidation(c)}>Validate</button>
                        </div>
                      </div>
                    ))}
                    {codes.length>50 && <div className="text-xs text-slate-500">Showing first 50… refine your search to narrow results.</div>}
                  </div>
                ) : null}
              </div>

              {/* Validation */}
              <div className="card space-y-3">
                <div className="flex items-center justify-between">
                  <h2 className="title">Validation List</h2>
                  <div className="flex gap-2">
                    <button className="btn" onClick={validateAll}>Validate All</button>
                    <button className="btn" onClick={clearVal}>Clear</button>
                  </div>
                </div>
                {valList.length ? (
                  <div className="overflow-auto">
                    <table className="table">
                      <thead>
                        <tr><th>Code</th><th>Display</th><th>Exists</th><th>In ValueSet</th><th>Mappings</th><th></th></tr>
                      </thead>
                      <tbody>
                        {valList.map((v,i)=>(
                          <tr key={i}>
                            <td className="mono">{v.code}</td>
                            <td>{v.display||''}</td>
                            <td>{v.result ? (v.result.exists ? '✔︎' : '—') : '…'}</td>
                            <td>{v.result ? (v.result.inValueSet ? '✔︎' : '—') : '…'}</td>
                            <td>{v.result ? ((v.result.mappings||[]).length) : '…'}</td>
                            <td><button className="btn" onClick={()=>removeVal(v.code)}>Remove</button></td>
                          </tr>
                        ))}
                      </tbody>
                    </table>
                  </div>
                ) : <div className="text-sm text-slate-500">Use <span className="font-semibold">Insert</span> or <span className="font-semibold">Validate</span> in Search to add items here.</div>}
              </div>
            </section>

            {/* ValueSet & ConceptMap */}
            <section className="grid md:grid-cols-2 gap-5">
              <div className="card space-y-3">
                <div className="flex items-center justify-between">
                  <h2 className="title">ValueSet</h2>
                  <div className="flex gap-2 flex-wrap">
                    <button className="btn" onClick={()=>http(apiBase,'/valueset').then(setVs).catch(e=>alert(e.message))}>Load</button>
                    <button className="btn" onClick={()=>exportValueSet('json')}>JSON</button>
                    <button className="btn" onClick={()=>exportValueSet('ndjson')}>NDJSON</button>
                    <button className="btn" onClick={()=>exportValueSet('csv')}>CSV</button>
                    <button className="btn" disabled={buildingCodes} onClick={exportCodesCSV}>{buildingCodes?'Building…':'Codes CSV'}</button>
                  </div>
                </div>
                {vs && <CodeBlock data={vs}/>}
              </div>

              <div className="card space-y-3">
                <div className="flex items-center justify-between">
                  <h2 className="title">ConceptMap</h2>
                  <div className="flex gap-2 flex-wrap">
                    <button className="btn" onClick={()=>http(apiBase,'/conceptmap').then(setCmap).catch(e=>alert(e.message))}>Load</button>
                    <button className="btn" onClick={()=>exportConceptMap('json')}>JSON</button>
                    <button className="btn" onClick={()=>exportConceptMap('ndjson')}>NDJSON</button>
                    <button className="btn" onClick={()=>exportConceptMap('csv')}>CSV</button>
                  </div>
                </div>
                {cmap && <CodeBlock data={cmap}/>}
              </div>
            </section>

            {/* FHIR Bundle */}
            <section className="card space-y-3">
              <div className="flex items-center justify-between flex-wrap gap-3">
                <h2 className="title">FHIR Bundle → Summary</h2>
                <div className="flex gap-2 flex-wrap">
                  <input type="file" className="hidden" ref={(el)=>{window._fileInput=el;}} onChange={importFileChanged} accept="application/json,.json"/>
                  <button className="btn" onClick={()=>window._fileInput?.click()}>Import FHIR (JSON)</button>
                  <button className="btn" onClick={()=>downloadBundle('fhir-bundle.json')}>Download FHIR</button>
                  <button className="btn" onClick={exportFHIR}>Export FHIR</button>
                  <button className="btn btn-primary" onClick={summarizeBundle}>Summarize Bundle</button>
                </div>
              </div>

              <div className="grid md:grid-cols-2 gap-4">
                <textarea className="input mono min-h-[280px]" value={bundleText} onChange={e=>setBundleText(e.target.value)} />
                <div className="space-y-2">
                  {bundleSummary
                    ? <>
                        <div className="text-sm text-slate-600">Summary:</div>
                        <CodeBlock data={bundleSummary}/>
                        <div className="flex gap-2">
                          <button className="btn" onClick={()=>downloadText('bundle-summary.json', JSON.stringify(bundleSummary,null,2))}>Download Summary</button>
                        </div>
                      </>
                    : <div className="text-sm text-slate-500">Paste or import a FHIR Bundle JSON, then click <span className="font-semibold">Summarize Bundle</span>.</div>}
                </div>
              </div>
            </section>

            <footer className="text-xs text-slate-500 text-center">© SAARTHI — Demo dataset for evaluation only</footer>
          </div>
        );
      }

      ReactDOM.createRoot(document.getElementById('root')).render(<App/>);
    </script>
  </body>
</html>
