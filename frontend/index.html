<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>SAARTHI Starter UI</title>

    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- React 18 UMD + Babel so JSX works without a build step -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
      :root {
        --fg: #0f172a;
        --muted: #475569;
        --line: #e5e7eb;
        --card: #ffffff;
        --bg: #f8fafc;
        --brand: #2563eb;
      }
      body { color: var(--fg); background: var(--bg); }
      .card { background: var(--card); border: 1px solid var(--line); border-radius: 16px; padding: 20px; }
      .btn { display:inline-flex; align-items:center; justify-content:center; gap:8px; padding:10px 14px; font-weight:600; border-radius: 12px; border:1px solid var(--line); background:#fff; transition: all .15s; }
      .btn:hover { transform: translateY(-1px); }
      .btn-primary { background: var(--brand); color: #fff; border-color: #1d4ed8; }
      .btn-ghost { background: #fff; }
      .badge { display:inline-flex; align-items:center; gap:6px; padding:4px 10px; border:1px solid var(--line); border-radius:999px; font-size:12px; background:#f1f5f9; color:#334155; }
      .input { border:1px solid var(--line); border-radius:12px; padding:10px 12px; outline:none; width:100%; background:#fff; }
      .input:focus { border-color:#2563eb; box-shadow:0 0 0 3px rgba(37,99,235,0.15); }
      .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
      .kbd { font-size:12px; background:#f1f5f9; border:1px solid var(--line); padding:2px 6px; border-radius:6px; }
      .toolbar { display:flex; gap:10px; flex-wrap:wrap; }
      .toast { position: fixed; right: 16px; bottom: 16px; background: #111827; color:#fff; padding: 12px 14px; border-radius:12px; box-shadow: 0 8px 24px rgba(0,0,0,.2); }
      .link { color: var(--brand); text-decoration: underline; }
    </style>
  </head>
  <body>
    <div id="root"></div>

    <script type="text/babel" data-presets="react">
      const { useEffect, useMemo, useRef, useState } = React;

      // Allow ?api=https://your-api.onrender.com; fallback to localhost for dev
      const API_BASE = (new URLSearchParams(location.search).get('api')) || 'http://localhost:8000';

      // fetch helper — only add Content-Type when sending a body
      async function api(path, opts = {}) {
        const hasBody = typeof opts.body !== "undefined";
        const headers = hasBody ? { "Content-Type": "application/json" } : {};
        const res = await fetch(API_BASE + path, { ...opts, headers: { ...headers, ...(opts.headers || {}) } });
        if (!res.ok) {
          let txt = "";
          try { txt = await res.text(); } catch {}
          throw new Error(`HTTP ${res.status} ${res.statusText}${txt ? " — "+txt : ""}`);
        }
        const ct = res.headers.get("content-type") || "";
        return ct.includes("application/json") ? res.json() : res.text();
      }

      function CodeBlock({ data }) {
        const text = typeof data === "string" ? data : JSON.stringify(data, null, 2);
        return (
          <pre className="mono text-xs bg-slate-50 border border-slate-200 rounded-xl p-3 overflow-auto max-h-96 whitespace-pre-wrap">
{String(text)}
          </pre>
        );
      }

      function useToast() {
        const [msg, setMsg] = useState("");
        function show(m) { setMsg(m); setTimeout(()=> setMsg(""), 3200); }
        return { msg, show };
      }

      function App() {
        const { msg, show } = useToast();

        const [pingOk, setPingOk] = useState(false);
        useEffect(() => {
          // hit a small JSON route for health
          fetch(API_BASE + "/openapi.json").then(r => setPingOk(r.ok)).catch(()=> setPingOk(false));
        }, []);

        // Search
        const [q, setQ] = useState("");
        const [codes, setCodes] = useState([]);

        async function doSearch() {
          try {
            setCodes([]);
            const data = await api(`/codes/search?q=${encodeURIComponent(q)}`);
            setCodes(data || []);
          } catch (e) { show(e.message); }
        }

        // ValueSet & ConceptMap
        const [vs, setVs] = useState(null);
        const [cmap, setCmap] = useState(null);
        async function loadVS(){ try { setVs(await api("/valueset")); } catch(e){ show(e.message); } }
        async function loadCMap(){ try { setCmap(await api("/conceptmap")); } catch(e){ show(e.message); } }

        // FHIR Bundle editor
        const [bundleText, setBundleText] = useState(`{
  "resourceType": "Bundle",
  "type": "collection",
  "entry": [
    { "resource": { "resourceType": "Patient", "id": "pat-1" } },
    { "resource": { "resourceType": "Encounter", "id": "enc-1" } },
    { "resource": { "resourceType": "Condition",
      "code": { "coding": [ { "system":"urn:icd:icd11:tm", "code":"TM2-0004", "display":"Amlapitta" } ] } } },
    { "resource": { "resourceType": "Procedure",
      "code": { "coding": [ { "system":"urn:icd:icd11:tm", "code":"TM2-PROC-003", "display":"Vamana Karma" } ] } } },
    { "resource": { "resourceType": "Observation",
      "code": { "text": "Dosha Assessment" }, "valueString": "Pitta dominant" } }
  ]
}`);
        const [bundleSummary, setBundleSummary] = useState(null);

        async function summarizeBundle() {
          try {
            const obj = JSON.parse(bundleText);
            const data = await api("/bundle/summary", { method: "POST", body: JSON.stringify(obj) });
            setBundleSummary(data);
            show("Bundle summarized");
          } catch (e) { show(e.message || "Invalid JSON"); }
        }

        // Import: read .json and load into editor
        const fileRef = useRef(null);
        function clickImport(){ fileRef.current?.click(); }
        function importFileChanged(e){
          const f = e.target.files?.[0];
          if (!f) return;
          const reader = new FileReader();
          reader.onload = () => {
            try {
              const txt = String(reader.result || "");
              JSON.parse(txt); // basic validation
              setBundleText(txt);
              show(`Imported ${f.name}`);
            } catch {
              show("Invalid JSON file");
            }
          };
          reader.readAsText(f);
          // reset so selecting same file again still triggers change
          e.target.value = "";
        }

        // Download current bundle as JSON
        function downloadBundle(filename = "fhir-bundle.json") {
          try {
            const txt = bundleText.trim();
            JSON.parse(txt); // validate
            const blob = new Blob([txt], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url; a.download = filename; a.click();
            URL.revokeObjectURL(url);
            show("Downloaded bundle");
          } catch {
            show("Bundle is not valid JSON");
          }
        }

        // Try API export if available; fall back to download
        async function exportFHIR() {
          try {
            const obj = JSON.parse(bundleText);
            // Common patterns (adjust if your API has a specific path)
            // 1) /export/fhir/bundle
            let res;
            try {
              res = await api("/export/fhir/bundle", { method: "POST", body: JSON.stringify(obj) });
            } catch {
              // 2) /export/bundle
              res = await api("/export/bundle", { method: "POST", body: JSON.stringify(obj) });
            }
            // If API returns a Bundle or a string, let user download it
            const data = typeof res === "string" ? res : JSON.stringify(res, null, 2);
            const blob = new Blob([data], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url; a.download = "fhir-bundle-export.json"; a.click();
            URL.revokeObjectURL(url);
            show("Exported via API");
          } catch (e) {
            // graceful fallback
            downloadBundle("fhir-bundle-export.json");
            show("Exported locally (fallback)");
          }
        }

        return (
          <div className="max-w-6xl mx-auto p-6 space-y-6">
            <header className="flex items-center justify-between">
              <div>
                <h1 className="text-2xl md:text-3xl font-bold tracking-tight">SAARTHI Starter UI</h1>
                <p className="text-sm text-slate-600 mt-1">
                  API: <span className="badge">{API_BASE}</span>
                </p>
              </div>
              <div className={`badge ${pingOk ? "border-green-200 bg-green-50 text-green-700" : "border-amber-200 bg-amber-50 text-amber-700"}`}>
                {pingOk ? "API online" : "Waiting for API…"}
              </div>
            </header>

            <section className="card space-y-3">
              <h2 className="text-lg font-semibold">Search Codes</h2>
              <div className="flex gap-2">
                <input
                  className="input"
                  placeholder="Try: Amlapitta, Sandhivata, Vamana, Nasya"
                  value={q}
                  onChange={e=>setQ(e.target.value)}
                  onKeyDown={e=>{ if (e.key === "Enter") doSearch(); }}
                />
                <button className="btn btn-primary" onClick={doSearch}>Search</button>
              </div>
              {codes?.length ? (
                <>
                  <div className="text-sm text-slate-600">Results: <span className="mono">{codes.length}</span></div>
                  <CodeBlock data={codes}/>
                </>
              ) : <div className="text-sm text-slate-500">No results yet. Enter a query and press <span className="kbd">Enter</span> or click <span className="kbd">Search</span>.</div>}
            </section>

            <section className="grid md:grid-cols-2 gap-5">
              <div className="card space-y-3">
                <h2 className="text-lg font-semibold">ValueSet (demo)</h2>
                <div className="toolbar">
                  <button className="btn btn-ghost" onClick={loadVS}>Load ValueSet</button>
                </div>
                {vs && <CodeBlock data={vs}/>}
              </div>

              <div className="card space-y-3">
                <h2 className="text-lg font-semibold">ConceptMap (demo)</h2>
                <div className="toolbar">
                  <button className="btn btn-ghost" onClick={loadCMap}>Load ConceptMap</button>
                </div>
                {cmap && <CodeBlock data={cmap}/>}
              </div>
            </section>

            <section className="card space-y-3">
              <div className="flex items-center justify-between flex-wrap gap-3">
                <h2 className="text-lg font-semibold">FHIR Bundle → Summary</h2>
                <div className="toolbar">
                  <input ref={fileRef} type="file" accept="application/json,.json" className="hidden" onChange={importFileChanged}/>
                  <button className="btn" onClick={clickImport}>Import FHIR (JSON)</button>
                  <button className="btn" onClick={()=>downloadBundle("fhir-bundle.json")}>Download FHIR</button>
                  <button className="btn" onClick={exportFHIR}>Export FHIR</button>
                  <button className="btn btn-primary" onClick={summarizeBundle}>Summarize Bundle</button>
                </div>
              </div>

              <div className="grid md:grid-cols-2 gap-4">
                <textarea
                  className="input mono min-h-[260px]"
                  value={bundleText}
                  onChange={e=>setBundleText(e.target.value)}
                />
                <div className="space-y-2">
                  {bundleSummary
                    ? <>
                        <div className="text-sm text-slate-600">Summary:</div>
                        <CodeBlock data={bundleSummary}/>
                      </>
                    : <div className="text-sm text-slate-500">Paste or import a FHIR Bundle (JSON). Click <span className="kbd">Summarize Bundle</span>.</div>}
                </div>
              </div>
            </section>

            <footer className="text-xs text-slate-500 text-center">© SAARTHI Starter Kit — Demo subset for evaluation only</footer>

            {msg && <div className="toast mono text-sm">{msg}</div>}
          </div>
        );
      }

      ReactDOM.createRoot(document.getElementById("root")).render(<App/>);
    </script>
  </body>
</html>
